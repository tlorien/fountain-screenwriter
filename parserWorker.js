var ParserWorker=(()=>{var F=Object.create;var $=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var P=(t,c)=>()=>(c||t((c={exports:{}}).exports,c),c.exports);var w=(t,c,b,g)=>{if(c&&typeof c=="object"||typeof c=="function")for(let f of G(c))!N.call(t,f)&&f!==b&&$(t,f,{get:()=>c[f],enumerable:!(g=R(c,f))||g.enumerable});return t};var Y=(t,c,b)=>(b=t!=null?F(H(t)):{},w(c||!t||!t.__esModule?$(b,"default",{value:t,enumerable:!0}):b,t)),q=t=>w($({},"__esModule",{value:!0}),t);var T=P((A,v)=>{(function(){"use strict";var t={title_page:/^((?:title|credit|author[s]?|source|notes|(?:draft )?date|contact(?: info)?|copyright|revision)\:)/gim,scene_heading:/^((?:\*{0,3}_?)?(?:(?:int|ext|est|i\/e)[. ]).+)|^(?:\.(?!\.+))(.+)/i,scene_number:/( *#(.+)# *)/,transition:/^((?:FADE (?:TO BLACK|OUT)|CUT TO BLACK)\.|.+ TO\:)|^(?:> *)(.+)/,dialogue:/^([A-Z*_]+[0-9A-Z (._\-')]*)(\^?)?(?:\n(?!\n+))([\s\S]+)/,parenthetical:/^(\(.+\))$/,action:/^(.+)/g,centered:/^(?:> *)(.+)(?: *<)(\n.+)*/g,section:/^(#+)(?: *)(.*)/,synopsis:/^(?:\=(?!\=+) *)(.*)/,note:/^(?:\[{2}(?!\[+))(.+)(?:\]{2}(?!\[+))$/,note_inline:/(?:\[{2}(?!\[+))([\s\S]+?)(?:\]{2}(?!\[+))/g,boneyard:/(^\/\*|^\*\/)$/g,page_break:/^\={3,}$/,line_break:/^ {2}$/,emphasis:/(_|\*{1,3}|_\*{1,3}|\*{1,3}_)(.+)(_|\*{1,3}|_\*{1,3}|\*{1,3}_)/g,bold_italic_underline:/(_{1}\*{3}(?=.+\*{3}_{1})|\*{3}_{1}(?=.+_{1}\*{3}))(.+?)(\*{3}_{1}|_{1}\*{3})/g,bold_underline:/(_{1}\*{2}(?=.+\*{2}_{1})|\*{2}_{1}(?=.+_{1}\*{2}))(.+?)(\*{2}_{1}|_{1}\*{2})/g,italic_underline:/(?:_{1}\*{1}(?=.+\*{1}_{1})|\*{1}_{1}(?=.+_{1}\*{1}))(.+?)(\*{1}_{1}|_{1}\*{1})/g,bold_italic:/(\*{3}(?=.+\*{3}))(.+?)(\*{3})/g,bold:/(\*{2}(?=.+\*{2}))(.+?)(\*{2})/g,italic:/(\*{1}(?=.+\*{1}))(.+?)(\*{1})/g,underline:/(_{1}(?=.+_{1}))(.+?)(_{1})/g,splitter:/\n{2,}/g,cleaner:/^\n+|\n+$/,standardizer:/\r\n|\r/g,whitespacer:/^\t+|^ {3,}/gm},c=function(o){return o.replace(t.boneyard,`
$1
`).replace(t.standardizer,`
`).replace(t.cleaner,"").replace(t.whitespacer,"")},b=function(o){for(var d=c(o).split(t.splitter),h=d.length,s,e,n,a,p,r,x,y,i=[];h--;){if(s=d[h],t.title_page.test(s)){for(e=s.replace(t.title_page,`
$1`).split(t.splitter).reverse(),r=0,x=e.length;r<x;r++)n=e[r].replace(t.cleaner,"").split(/\:\n*/),i.push({type:n[0].trim().toLowerCase().replace(" ","_"),text:n[1].trim()});continue}if(e=s.match(t.scene_heading)){a=e[1]||e[2],a.indexOf("  ")!==a.length-2&&((p=a.match(t.scene_number))&&(p=p[2],a=a.replace(t.scene_number,"")),i.push({type:"scene_heading",text:a,scene_number:p||void 0}));continue}if(e=s.match(t.centered)){i.push({type:"centered",text:e[0].replace(/>|</g,"")});continue}if(e=s.match(t.transition)){i.push({type:"transition",text:e[1]||e[2]});continue}if((e=s.match(t.dialogue))&&e[1].indexOf("  ")!==e[1].length-2){for(e[2]&&i.push({type:"dual_dialogue_end"}),i.push({type:"dialogue_end"}),n=e[3].split(/(\(.+\))(?:\n+)/).reverse(),r=0,x=n.length;r<x;r++)a=n[r],a.length>0&&i.push({type:t.parenthetical.test(a)?"parenthetical":"dialogue",text:a});i.push({type:"character",text:e[1].trim()}),i.push({type:"dialogue_begin",dual:e[2]?"right":y?"left":void 0}),y&&i.push({type:"dual_dialogue_begin"}),y=!!e[2];continue}if(e=s.match(t.section)){i.push({type:"section",text:e[2],depth:e[1].length});continue}if(e=s.match(t.synopsis)){i.push({type:"synopsis",text:e[1]});continue}if(e=s.match(t.note)){i.push({type:"note",text:e[1]});continue}if(e=s.match(t.boneyard)){i.push({type:e[0][0]==="/"?"boneyard_begin":"boneyard_end"});continue}if(t.page_break.test(s)){i.push({type:"page_break"});continue}if(t.line_break.test(s)){i.push({type:"line_break"});continue}i.push({type:"action",text:s})}return i},g={note:"<!-- $1 -->",line_break:"<br />",bold_italic_underline:'<span class="bold italic underline">$2</span>',bold_underline:'<span class="bold underline">$2</span>',italic_underline:'<span class="italic underline">$2</span>',bold_italic:'<span class="bold italic">$2</span>',bold:'<span class="bold">$2</span>',italic:'<span class="italic">$2</span>',underline:'<span class="underline">$2</span>'};g.lexer=function(o){if(o){var d=["underline","italic","bold","bold_italic","italic_underline","bold_underline","bold_italic_underline"],h=d.length,s,e;for(o=o.replace(t.note_inline,g.note).replace(/\\\*/g,"[star]").replace(/\\_/g,"[underline]").replace(/\n/g,g.line_break);h--;)s=d[h],e=t[s],e.test(o)&&(o=o.replace(e,g[s]));return o.replace(/\[star\]/g,"*").replace(/\[underline\]/g,"_").trim()}};var f=function(o,d,h){h===void 0&&typeof d=="function"&&(h=d,d=void 0);for(var s=b(o),e=s.length,n,a,p,r,x,y,i,m,U,S,_=[],u=[],k;e--;)switch(n=s[e],n.text=g.lexer(n.text),n.type){case"title":_.push("<h1>"+n.text+"</h1>"),a=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"credit":_.push('<p class="credit">'+n.text+"</p>"),p=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"author":case"authors":_.push('<p class="authors">'+n.text+"</p>"),r=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"source":_.push('<p class="source">'+n.text+"</p>"),x=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"notes":_.push('<p class="notes">'+n.text+"</p>"),y=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"draft_date":case"date":_.push('<p class="draft-date">'+n.text+"</p>"),i=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"contact":case"contact_info":_.push('<p class="contact">'+n.text+"</p>"),m=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"copyright":_.push('<p class="copyright">'+n.text+"</p>"),U=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"revision":_.push('<p class="revision">'+n.text+"</p>"),S=n.text.replace("<br />"," ").replace(/<(?:.|\n)*?>/g,"");break;case"scene_heading":u.push("<h3"+(n.scene_number?' id="'+n.scene_number+'">':">")+n.text+"</h3>");break;case"transition":u.push("<h2>"+n.text+"</h2>");break;case"dual_dialogue_begin":u.push('<div class="dual-dialogue">');break;case"dialogue_begin":u.push('<div class="dialogue'+(n.dual?" "+n.dual:"")+'">');break;case"character":u.push("<h4>"+n.text+"</h4>");break;case"parenthetical":u.push('<p class="parenthetical">'+n.text+"</p>");break;case"dialogue":u.push("<p>"+n.text+"</p>");break;case"dialogue_end":u.push("</div> ");break;case"dual_dialogue_end":u.push("</div> ");break;case"section":u.push('<p class="section" data-depth="'+n.depth+'">'+n.text+"</p>");break;case"synopsis":u.push('<p class="synopsis">'+n.text+"</p>");break;case"note":u.push("<!-- "+n.text+"-->");break;case"boneyard_begin":u.push("<!-- ");break;case"boneyard_end":u.push(" -->");break;case"action":u.push("<p>"+n.text+"</p>");break;case"centered":u.push('<p class="centered">'+n.text+"</p>");break;case"page_break":u.push("<hr />");break;case"line_break":u.push("<br />");break}return k={title:a,credit:p,author:r,authors:r,source:x,notes:y,draft_date:i,date:i,contact:m,contact_info:m,copyright:U,revision:S,html:{title_page:_.join(""),script:u.join("")},tokens:d?s.reverse():void 0},typeof h=="function"?h(k):k},l=function(o,d){return l.parse(o,d)};l.parse=function(o,d,h){return f(o,d,h)},typeof v<"u"?v.exports=l:this.fountain=l}).call(A)});var J={},D=Y(T()),I=t=>t.replace(/^---[\s\S]*?---\s*\n*/u,""),E=t=>t.replace(/<[^>]+>/g,"").replace(/[_*~]/g,"").trim(),O=t=>t.replace(/^\./,"").replace(/\s+#[-A-Z0-9.]+#\s*$/i,"").trim().toUpperCase(),W=t=>t.replace(/^@/,"").replace(/\s*\([^)]+\)\s*$/,"").replace(/\s*\^\s*$/,"").trim().toUpperCase(),Z=t=>t.replace(/^~\s*/,"").trim().toUpperCase(),L=t=>t.replace(/^#+\s*/,"").trim().toUpperCase(),j=t=>t.replace(/^=\s*/,"").trim().toUpperCase(),z=t=>t.replace(/^\[\[|\]\]$/g,"").trim().toUpperCase(),B=t=>t.replace(/^>\s*/,"").replace(/\s*<\s*$/,"").trim().toUpperCase(),K=t=>t.replace(/^>\s*/,"").replace(/\s*:\s*$/,"").trim().toUpperCase(),M=new Set(["title","credit","author","authors","source","draft_date","date","contact"]),C=self;C.onmessage=({data:t})=>{try{let c=String(t),b=I(c),g=c.split(/\r?\n/),{tokens:f=[]}=D.default.parse(b,!0),l=[];f.forEach(e=>{String(e.text??"").split(/<br\s*\/?>/i).forEach((a,p)=>{if(!a.trim())return;let r={...e,text:a.trim()};p>0&&r.type==="character"&&(r.type="dialogue"),l.push(r)})});let o=/^([A-Z][A-Z0-9 ]+?)\s*\(([^)]+)\)$/i,d=/^@(.+)/i;for(let e of l){if(!e.text)continue;let n=e.text.match(d);if(n&&(e.type="character",e.text=n[1].trim()),e.type==="action"&&e.text.startsWith("~")&&(e.type="lyric",e.text=e.text.slice(1).trimStart()),e.type==="action"||e.type==="character"){let a=e.text.match(o);a&&(e.type="character",e.text=a[1].trim(),e.ext=a[2].trim())}if(e.type==="action"&&e.text.startsWith(">")){let a=e.text.slice(1).trim();a.endsWith("<")?(e.type="centered",e.text=a.slice(0,-1).trim()):(e.type="transition",e.text=a)}e.type==="character"&&/\^\s*$/.test(e.text)&&(e.text=e.text.replace(/\^\s*$/,"").trimEnd(),e.dual=!0),e.type==="dialogue"&&/^\~/.test(e.text)&&(e.type="lyric",e.text=e.text.slice(1).trim())}let h=0;for(let e of l){if(!e.text){e.line=-1;continue}let n=e.type==="scene_heading"?O(e.text):e.type==="character"?W(e.text):e.type==="lyric"?Z(e.text):e.type==="section"?L(e.text):e.type==="synopsis"?j(e.text):e.type==="note"?z(e.text):e.type==="centered"?B(e.text):e.type==="transition"?K(e.text):M.has(e.type)?e.text.trim().toUpperCase():E(e.text).toUpperCase(),a=-1;for(let p=h;p<g.length;p++){let r=g[p].trim();if((e.type==="scene_heading"?O(r):e.type==="character"?W(r):e.type==="lyric"?Z(r):e.type==="section"?L(r):e.type==="synopsis"?j(r):e.type==="note"?z(r):e.type==="centered"?B(r):e.type==="transition"?K(r):M.has(e.type)?r.replace(/^[A-Z ]+:\s*/i,"").trim().toUpperCase():E(r).toUpperCase())===n){a=p,h=p+1;break}}e.line=a}let s=(e,n)=>g.slice(e+1,n).some(a=>/^\s*$/.test(a));for(let e=0;e<l.length;e++){let n=l[e];if(n.type!=="character")continue;let a=e+1,p=n.line;for(a<l.length&&l[a].text?.trimStart().startsWith("(")&&!s(p,l[a].line)&&(l[a].type="parenthetical",n.dual&&(l[a].dual=!0),p=l[a].line,a++);a<l.length;a++){let r=l[a];if(r.line!==-1){if(["character","scene_heading","section","transition","lyric"].includes(r.type)||s(p,r.line))break;r.type=r.text.trimStart().startsWith("(")?"parenthetical":"dialogue",n.dual&&(r.dual=!0),p=r.line}}}C.postMessage({tokens:l})}catch(c){C.postMessage({error:c.message})}};return q(J);})();
